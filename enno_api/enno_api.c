#include <stdio.h>
#include <stdbool.h>
#include "enno_api.h"

#include "azure_umqtt_c/mqtt_client.h"
#include "azure_c_shared_utility/socketio.h"
#include "azure_c_shared_utility/tlsio_openssl.h"
#include "azure_c_shared_utility/platform.h"

///////////////////////////////////////////////////////////////////////////////////////
static const char cer_pem[] =
"-----BEGIN CERTIFICATE-----\r\n"
"MIIDXTCCAkWgAwIBAgIELx2vOjANBgkqhkiG9w0BAQsFADBfMQswCQYDVQQGEwJD\r\n"
"TjEQMA4GA1UECBMHYmVpamluZzEQMA4GA1UEBxMHYmVpamluZzEPMA0GA1UEChMG\r\n"
"d2lzaW90MQswCQYDVQQLEwJpdDEOMAwGA1UEAxMFYWRtaW4wHhcNMTYwNDExMTU1\r\n"
"MDM2WhcNMTYwNzEwMTU1MDM2WjBfMQswCQYDVQQGEwJDTjEQMA4GA1UECBMHYmVp\r\n"
"amluZzEQMA4GA1UEBxMHYmVpamluZzEPMA0GA1UEChMGd2lzaW90MQswCQYDVQQL\r\n"
"EwJpdDEOMAwGA1UEAxMFYWRtaW4wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK\r\n"
"AoIBAQDfNA+HUH5U2s00L2mTuVSc1R0+5mIzGcj17fJSAmoFlMv4gJsM3YHM24TH\r\n"
"3IwaK6Zgwx1DT/Ju4UJhBUtmCafzu6A61gyXLVe8rfkszkMhOHkIT8n7533f4/me\r\n"
"wG6uAWflCZD5RHNxQ1Qy4+i0BUwLp57zfJMEEIQTKGGEpXaUMWUWDSPeLOuhbwhs\r\n"
"BtOJGD1iVXV4mtwCQH/2+MwWFAQY49cybUN8VmRlL7dTYBf8I/mVXg0FGTro3dL6\r\n"
"y9HnNkiMbMco/rPZpdBkOUfQnIlOZfThIVUFmtEEjHOKghfl18ssrYRJnVJ5XaEU\r\n"
"6u1sm7GbhKHa+Y+E3ODgdU2koa1hAgMBAAGjITAfMB0GA1UdDgQWBBRJfMAy9JFs\r\n"
"mMM3YKJNi//LzmkgODANBgkqhkiG9w0BAQsFAAOCAQEA1mUbtSYoDmTb6akrfzjn\r\n"
"WUZd2xCSiu/rCu07m0Wm2qKqYdfMaFcscKCcT2RdLfgOMCva/UIRdo/+l8Ch8M5c\r\n"
"XHNDqfQ3KDJElpjTM3jd0BPCcq6l/OJvDxaj2amNSoDNZTA7NQ9Jy6nR1Yw05XGX\r\n"
"InMd6K3BxMDSB1L5AZ+PMLnBL+4/c/hQwcMvJDciuEIake4R/54GI8fbdZv+pUYt\r\n"
"pYQZzUdUwkiDHgyqMwumkA0pq69i0+Y+xsPl0+nUx2JNRq0gxdcZN/3cRTogqZWf\r\n"
"GYjjqE2UTADxgo+e85QWY/+DWOaIjOTgBh+w3tgjXsRQaV3V1zYksSX3xC5uaklW\r\n"
"kg==\r\n"
"-----END CERTIFICATE-----\r\n";

static const char cer_der[] = {
	0x30,0x82,0x03,0x5d,0x30,0x82,0x02,0x45,0xa0,0x03,0x02,0x01,0x02,0x02,0x04,0x2f,
	0x1d,0xaf,0x3a,0x30,0x0d,0x06,0x09,0x2a,0x86,0x48,0x86,0xf7,0x0d,0x01,0x01,0x0b,
	0x05,0x00,0x30,0x5f,0x31,0x0b,0x30,0x09,0x06,0x03,0x55,0x04,0x06,0x13,0x02,0x43,
	0x4e,0x31,0x10,0x30,0x0e,0x06,0x03,0x55,0x04,0x08,0x13,0x07,0x62,0x65,0x69,0x6a,
	0x69,0x6e,0x67,0x31,0x10,0x30,0x0e,0x06,0x03,0x55,0x04,0x07,0x13,0x07,0x62,0x65,
	0x69,0x6a,0x69,0x6e,0x67,0x31,0x0f,0x30,0x0d,0x06,0x03,0x55,0x04,0x0a,0x13,0x06,
	0x77,0x69,0x73,0x69,0x6f,0x74,0x31,0x0b,0x30,0x09,0x06,0x03,0x55,0x04,0x0b,0x13,
	0x02,0x69,0x74,0x31,0x0e,0x30,0x0c,0x06,0x03,0x55,0x04,0x03,0x13,0x05,0x61,0x64,
	0x6d,0x69,0x6e,0x30,0x1e,0x17,0x0d,0x31,0x36,0x30,0x34,0x31,0x31,0x31,0x35,0x35,
	0x30,0x33,0x36,0x5a,0x17,0x0d,0x31,0x36,0x30,0x37,0x31,0x30,0x31,0x35,0x35,0x30,
	0x33,0x36,0x5a,0x30,0x5f,0x31,0x0b,0x30,0x09,0x06,0x03,0x55,0x04,0x06,0x13,0x02,
	0x43,0x4e,0x31,0x10,0x30,0x0e,0x06,0x03,0x55,0x04,0x08,0x13,0x07,0x62,0x65,0x69,
	0x6a,0x69,0x6e,0x67,0x31,0x10,0x30,0x0e,0x06,0x03,0x55,0x04,0x07,0x13,0x07,0x62,
	0x65,0x69,0x6a,0x69,0x6e,0x67,0x31,0x0f,0x30,0x0d,0x06,0x03,0x55,0x04,0x0a,0x13,
	0x06,0x77,0x69,0x73,0x69,0x6f,0x74,0x31,0x0b,0x30,0x09,0x06,0x03,0x55,0x04,0x0b,
	0x13,0x02,0x69,0x74,0x31,0x0e,0x30,0x0c,0x06,0x03,0x55,0x04,0x03,0x13,0x05,0x61,
	0x64,0x6d,0x69,0x6e,0x30,0x82,0x01,0x22,0x30,0x0d,0x06,0x09,0x2a,0x86,0x48,0x86,
	0xf7,0x0d,0x01,0x01,0x01,0x05,0x00,0x03,0x82,0x01,0x0f,0x00,0x30,0x82,0x01,0x0a,
	0x02,0x82,0x01,0x01,0x00,0xdf,0x34,0x0f,0x87,0x50,0x7e,0x54,0xda,0xcd,0x34,0x2f,
	0x69,0x93,0xb9,0x54,0x9c,0xd5,0x1d,0x3e,0xe6,0x62,0x33,0x19,0xc8,0xf5,0xed,0xf2,
	0x52,0x02,0x6a,0x05,0x94,0xcb,0xf8,0x80,0x9b,0x0c,0xdd,0x81,0xcc,0xdb,0x84,0xc7,
	0xdc,0x8c,0x1a,0x2b,0xa6,0x60,0xc3,0x1d,0x43,0x4f,0xf2,0x6e,0xe1,0x42,0x61,0x05,
	0x4b,0x66,0x09,0xa7,0xf3,0xbb,0xa0,0x3a,0xd6,0x0c,0x97,0x2d,0x57,0xbc,0xad,0xf9,
	0x2c,0xce,0x43,0x21,0x38,0x79,0x08,0x4f,0xc9,0xfb,0xe7,0x7d,0xdf,0xe3,0xf9,0x9e,
	0xc0,0x6e,0xae,0x01,0x67,0xe5,0x09,0x90,0xf9,0x44,0x73,0x71,0x43,0x54,0x32,0xe3,
	0xe8,0xb4,0x05,0x4c,0x0b,0xa7,0x9e,0xf3,0x7c,0x93,0x04,0x10,0x84,0x13,0x28,0x61,
	0x84,0xa5,0x76,0x94,0x31,0x65,0x16,0x0d,0x23,0xde,0x2c,0xeb,0xa1,0x6f,0x08,0x6c,
	0x06,0xd3,0x89,0x18,0x3d,0x62,0x55,0x75,0x78,0x9a,0xdc,0x02,0x40,0x7f,0xf6,0xf8,
	0xcc,0x16,0x14,0x04,0x18,0xe3,0xd7,0x32,0x6d,0x43,0x7c,0x56,0x64,0x65,0x2f,0xb7,
	0x53,0x60,0x17,0xfc,0x23,0xf9,0x95,0x5e,0x0d,0x05,0x19,0x3a,0xe8,0xdd,0xd2,0xfa,
	0xcb,0xd1,0xe7,0x36,0x48,0x8c,0x6c,0xc7,0x28,0xfe,0xb3,0xd9,0xa5,0xd0,0x64,0x39,
	0x47,0xd0,0x9c,0x89,0x4e,0x65,0xf4,0xe1,0x21,0x55,0x05,0x9a,0xd1,0x04,0x8c,0x73,
	0x8a,0x82,0x17,0xe5,0xd7,0xcb,0x2c,0xad,0x84,0x49,0x9d,0x52,0x79,0x5d,0xa1,0x14,
	0xea,0xed,0x6c,0x9b,0xb1,0x9b,0x84,0xa1,0xda,0xf9,0x8f,0x84,0xdc,0xe0,0xe0,0x75,
	0x4d,0xa4,0xa1,0xad,0x61,0x02,0x03,0x01,0x00,0x01,0xa3,0x21,0x30,0x1f,0x30,0x1d,
	0x06,0x03,0x55,0x1d,0x0e,0x04,0x16,0x04,0x14,0x49,0x7c,0xc0,0x32,0xf4,0x91,0x6c,
	0x98,0xc3,0x37,0x60,0xa2,0x4d,0x8b,0xff,0xcb,0xce,0x69,0x20,0x38,0x30,0x0d,0x06,
	0x09,0x2a,0x86,0x48,0x86,0xf7,0x0d,0x01,0x01,0x0b,0x05,0x00,0x03,0x82,0x01,0x01,
	0x00,0xd6,0x65,0x1b,0xb5,0x26,0x28,0x0e,0x64,0xdb,0xe9,0xa9,0x2b,0x7f,0x38,0xe7,
	0x59,0x46,0x5d,0xdb,0x10,0x92,0x8a,0xef,0xeb,0x0a,0xed,0x3b,0x9b,0x45,0xa6,0xda,
	0xa2,0xaa,0x61,0xd7,0xcc,0x68,0x57,0x2c,0x70,0xa0,0x9c,0x4f,0x64,0x5d,0x2d,0xf8,
	0x0e,0x30,0x2b,0xda,0xfd,0x42,0x11,0x76,0x8f,0xfe,0x97,0xc0,0xa1,0xf0,0xce,0x5c,
	0x5c,0x73,0x43,0xa9,0xf4,0x37,0x28,0x32,0x44,0x96,0x98,0xd3,0x33,0x78,0xdd,0xd0,
	0x13,0xc2,0x72,0xae,0xa5,0xfc,0xe2,0x6f,0x0f,0x16,0xa3,0xd9,0xa9,0x8d,0x4a,0x80,
	0xcd,0x65,0x30,0x3b,0x35,0x0f,0x49,0xcb,0xa9,0xd1,0xd5,0x8c,0x34,0xe5,0x71,0x97,
	0x22,0x73,0x1d,0xe8,0xad,0xc1,0xc4,0xc0,0xd2,0x07,0x52,0xf9,0x01,0x9f,0x8f,0x30,
	0xb9,0xc1,0x2f,0xee,0x3f,0x73,0xf8,0x50,0xc1,0xc3,0x2f,0x24,0x37,0x22,0xb8,0x42,
	0x1a,0x91,0xee,0x11,0xff,0x9e,0x06,0x23,0xc7,0xdb,0x75,0x9b,0xfe,0xa5,0x46,0x2d,
	0xa5,0x84,0x19,0xcd,0x47,0x54,0xc2,0x48,0x83,0x1e,0x0c,0xaa,0x33,0x0b,0xa6,0x90,
	0x0d,0x29,0xab,0xaf,0x62,0xd3,0xe6,0x3e,0xc6,0xc3,0xe5,0xd3,0xe9,0xd4,0xc7,0x62,
	0x4d,0x46,0xad,0x20,0xc5,0xd7,0x19,0x37,0xfd,0xdc,0x45,0x3a,0x20,0xa9,0x95,0x9f,
	0x19,0x88,0xe3,0xa8,0x4d,0x94,0x4c,0x00,0xf1,0x82,0x8f,0x9e,0xf3,0x94,0x16,0x63,
	0xff,0x83,0x58,0xe6,0x88,0x8c,0xe4,0xe0,0x06,0x1f,0xb0,0xde,0xd8,0x23,0x5e,0xc4,
	0x50,0x69,0x5d,0xd5,0xd7,0x36,0x24,0xb1,0x25,0xf7,0xc4,0x2e,0x6e,0x6a,0x49,0x56,
	0x92
};
///////////////////////////////////////////////////////////////////////////////




static void OnRecvCallback(MQTT_MESSAGE_HANDLE msgHandle, void* context)
{
	const APP_PAYLOAD* appMsg = mqttmessage_getApplicationMsg(msgHandle);
	ENNO_CLIENT* pClient = (ENNO_CLIENT*)context;
	if (pClient->on_message)
	{
		uint8_t ch = appMsg->message[appMsg->length];
		appMsg->message[appMsg->length] = 0;
		pClient->on_message(pClient, mqttmessage_getTopicName(msgHandle), appMsg->message, appMsg->length);
		appMsg->message[appMsg->length] = ch;
	}
}

static uint16_t PACKET_ID_VALUE = 11;
static void OnOperationComplete(MQTT_CLIENT_HANDLE handle, MQTT_CLIENT_EVENT_RESULT actionResult, const void* msgInfo, void* callbackCtx)
{
	ENNO_CLIENT *pClient = callbackCtx;
	switch (actionResult)
	{
	case MQTT_CLIENT_ON_CONNACK:
	{
		pClient->gState = ENNO_CONNECTED;
		pClient->fn_log(LOG_LINE, "ConnAck function called");
		const CONNECT_ACK* connack = (CONNECT_ACK*)msgInfo;
		SUBSCRIBE_PAYLOAD subscribe[] = {
			{ pClient->subscrib[0], DELIVER_AT_MOST_ONCE },
			{ pClient->subscrib[1], DELIVER_EXACTLY_ONCE },
		};
		if (mqtt_client_subscribe(handle, PACKET_ID_VALUE++, subscribe, sizeof(subscribe) / sizeof(subscribe[0])) != 0)
		{
			pClient->fn_log(LOG_LINE, "%d: mqtt_client_subscribe failed", __LINE__);
			pClient->gState = ENNO_RETRY;
		}
		break;
	}
	case MQTT_CLIENT_ON_SUBSCRIBE_ACK:
	{
		const SUBSCRIBE_ACK* suback = (SUBSCRIBE_ACK*)msgInfo;
		MQTT_MESSAGE_HANDLE msg = mqttmessage_create(PACKET_ID_VALUE++, "TOPIC_NAME_A", DELIVER_EXACTLY_ONCE, "APP_NAME_A", strlen("APP_NAME_A"));
		if (msg == NULL)
		{
			pClient->fn_log(LOG_LINE, "%d: mqttmessage_create failed", __LINE__);
			pClient->gState = ENNO_RETRY;
		}
		else
		{
			if (mqtt_client_publish(handle, msg))
			{
				pClient->fn_log(LOG_LINE, "%d: mqtt_client_publish failed", __LINE__);
				pClient->gState = ENNO_RETRY;
			}
			mqttmessage_destroy(msg);
		}
		// Now send a message that will get 
		break;
	}
	case MQTT_CLIENT_ON_PUBLISH_ACK:
	{
		const PUBLISH_ACK* puback = (PUBLISH_ACK*)msgInfo;
		break;
	}
	case MQTT_CLIENT_ON_PUBLISH_RECV:
	{
		const PUBLISH_ACK* puback = (PUBLISH_ACK*)msgInfo;
		break;
	}
	case MQTT_CLIENT_ON_PUBLISH_REL:
	{
		const PUBLISH_ACK* puback = (PUBLISH_ACK*)msgInfo;
		break;
	}
	case MQTT_CLIENT_ON_PUBLISH_COMP:
	{
		const PUBLISH_ACK* puback = (PUBLISH_ACK*)msgInfo;
		// Done so send disconnect
		//mqtt_client_disconnect(handle);
		break;
	}
	case MQTT_CLIENT_ON_ERROR:
	case MQTT_CLIENT_ON_DISCONNECT:
		pClient->gState = ENNO_RETRY;
		break;
	}
}



static void OnCloseComplete(void* callbackCtx)
{
	ENNO_CLIENT *pClient = callbackCtx;
}

bool enno_timeout(ENNO_CLIENT *pClient, uint32_t time_ms)
{
	if (pClient->current_ms == 0)
	{
		tickcounter_get_current_ms(pClient->packetTickCntr, &pClient->current_ms);
	}

	uint64_t tmp;
	tickcounter_get_current_ms(pClient->packetTickCntr, &tmp);

	uint64_t t = tmp - pClient->current_ms - time_ms;
	int a = (t >> 63);
	if (a == 0)
	{
		tickcounter_get_current_ms(pClient->packetTickCntr, &pClient->current_ms);
	}

	return !a;
}



Error_t enno_init(ENNO_CLIENT *pClient)
{
	pClient->gState = ENNO_INIT;
	pClient->packetTickCntr = tickcounter_create();
	pClient->current_ms = 0;
	return 0;
}

Error_t enno_deinit(ENNO_CLIENT *pClient)
{
	mqtt_client_disconnect(pClient->mqttHandle);
	return 0;
}

Error_t enno_publish(ENNO_CLIENT *pClient, char* path, char** value, int count)
{
	if (pClient->gState != ENNO_CONNECTED)
	{
		return -1;
	}
	char jsonValue[1024];
	jsonValue[0] = 0;
/*
{"type":"m","deviceId":"e583ea4a-9b5f-4e13-9996-461edd449b1a",
"ts":"2016-02-10T19:40:03.391Z",
"note":"this is the optional note",
"data":{
"1":"27.5",
"2":"23.000,34.000,53.000"
}
}
*/
	strcat(jsonValue,"{\"type\":\"m\",\"deviceId\":\"");
	strcat(jsonValue, pClient->deviceid);
	strcat(jsonValue, "\",\"data\":{");
	for (int i = 0; i < count; i++)
	{
		char index[] = "\"_\":\"";
		index[1] = '1' + i;
		strcat(jsonValue, index);
		strcat(jsonValue, value[i]);
		strcat(jsonValue, "\",");
	}
	jsonValue[strlen(jsonValue)-1] = 0;
	strcat(jsonValue, "}}");

	MQTT_MESSAGE_HANDLE msg = mqttmessage_create(PACKET_ID_VALUE++, path, DELIVER_EXACTLY_ONCE, jsonValue, strlen(jsonValue));
	if (msg == NULL)
	{
		pClient->fn_log(LOG_LINE, "%d: mqttmessage_create failed", __LINE__);
		pClient->gState = ENNO_RETRY;
	}
	else
	{
		if (mqtt_client_publish(pClient->mqttHandle, msg))
		{
			pClient->fn_log(LOG_LINE, "%d: mqtt_client_publish failed", __LINE__);
			pClient->gState = ENNO_RETRY;
			return -1;
		}
		mqttmessage_destroy(msg);
	}
	return 0;
}

Error_t enno_connect(ENNO_CLIENT *pClient)
{
	if (pClient->gState != ENNO_INIT)
	{
		return 0;
	}
	
	platform_init();

	MQTT_CLIENT_HANDLE mqttHandle = mqtt_client_init(OnRecvCallback, OnOperationComplete, pClient, pClient->fn_log);
	if (mqttHandle == NULL)
	{
		pClient->fn_log(LOG_LINE, "mqtt_client_init failed");
	}
	else
	{
		SOCKETIO_CONFIG config = { pClient->host, pClient->port, NULL };
		const IO_INTERFACE_DESCRIPTION* pio = NULL;
		if (pClient->port<2000)
		{
			pio = socketio_get_interface_description();
		}
		else
		{
#ifndef NO_SSL
			pio = tlsio_openssl_get_interface_description();
#endif
		}
		
		XIO_HANDLE xio = xio_create(pio, &config, pClient->fn_log);
		
		if (xio == NULL)
		{
			pClient->fn_log(LOG_LINE, "xio_create failed");
		}
		else
		{
			MQTT_CLIENT_OPTIONS options = { 0 };
			options.willTopic = NULL;
			options.willMessage = NULL;
			options.clientId = pClient->oter;
			options.username = pClient->deviceid;
			options.password = pClient->token;
			options.keepAliveInterval = 10;
			options.useCleanSession = true;
			options.qualityOfServiceValue = DELIVER_AT_MOST_ONCE;
			if (mqtt_client_connect(mqttHandle, xio, &options) != 0)
			{
				pClient->fn_log(LOG_LINE, "mqtt_client_connect failed");
			}
			else
			{
				pio->concrete_io_setoption( (void*)*(uint32_t*)((uint32_t)xio+4), "TrustedCerts", cer_pem);
				pClient->gState = ENNO_CONNECTING;
				pClient->mqttHandle = mqttHandle;
				return 0;
			}
			xio_close(xio, OnCloseComplete, NULL);
		}
		mqtt_client_deinit(mqttHandle);
	}
	platform_deinit();
	return -1;
}



Error_t enno_loop(ENNO_CLIENT *pClient)
{
	switch (pClient->gState)
	{
	case ENNO_INIT:
		enno_connect(pClient);
		break;

	case ENNO_RETRY:
		pClient->gState = ENNO_INIT;
		mqtt_client_deinit(pClient->mqttHandle);
		break;

	case ENNO_CONNECTING:
	case ENNO_CONNECTED:
		mqtt_client_dowork(pClient->mqttHandle);
		break;
	}
	return 0;
}




